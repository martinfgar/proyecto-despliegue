<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bolsa de Martin</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w=="
        crossorigin referrerpolicy="no-referrer">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/fontawesome.min.css"
        integrity="sha512-giQeaPns4lQTBMRpOOHsYnGw1tGVzbAIHUyHRgn7+6FmiEgGGjaG0T2LZJmAPMzRCl+Cug0ItQ2xDZpTmEc+CQ=="
        crossorigin referrerpolicy="no-referrer">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"
        integrity="sha384-cuYeSxntonz0PPNlHhBs68uyIAVpIIOZZ5JqeqvYYIcEL727kskC66kF92t6Xl2V" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/js/all.min.js"
        integrity="sha512-rpLlll167T5LJHwp0waJCh3ZRf7pO6IT1+LZOhAyP6phAirwchClbTZV3iqL3BMrVxIYRbzGTpli4rfxsCK6Vw=="
        crossorigin referrerpolicy="no-referrer"></script>
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"
        integrity="sha256-pvPw+upLPUjgMXY0G+8O0xUf+/Im1MZjXxxgOcBQBXU=" crossorigin></script>
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"
        integrity="sha256-lSjKY0/srUM9BE3dPm+c4fBo1dky2v27Gdjm2uoZaL0=" crossorigin></script>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/stock/modules/data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/stock/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
    <link rel="stylesheet" href="index.8279cd74.css">
</head>

<body>
    <nav class="bg-light navbar">
        <div class="container-fluid"> <a class="me-auto navbar-brand"></a>
            <div id="username" class="m-2"></div>
            <div class="ms-2"> <a role="button" id="logIn" data-bs-toggle="modal" data-bs-target="#loginModal"><i
                        class="fa-right-to-bracket fa-solid"></i></a> <a role="button" id="logOut" class="d-none"><i
                        class="fa-right-from-bracket fa-solid"></i></a> </div>
        </div>
    </nav>
    <main class="container-fluid" id="mainPanel">
        <div class="g-2 m-5 row">
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardiberdrola">
                <div class="card"> <img src="iberdrola.7b71389c.jpg" class="card-img-top" alt="Iberdrola">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-iberdrola"> </h5> <a role="button"
                                id="btn-iberdrola" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardcellnex">
                <div class="card"> <img src="cellnex.1d49f6a5.jpg" class="card-img-top" alt="Cellnex">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-cellnex"> </h5> <a role="button"
                                id="btn-cellnex" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardcaixabank">
                <div class="card"> <img src="caixabank.56d93953.jpg" class="card-img-top" alt="Caixabank">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-caixabank"> </h5> <a role="button"
                                id="btn-caixabank" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardtelefonica">
                <div class="card"> <img src="telefonica.86c45e26.jpg" class="card-img-top" alt="Telefónica">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-telefonica"> </h5> <a role="button"
                                id="btn-telefonica" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardnaturgy">
                <div class="card"> <img src="naturgy.2b60e181.jpg" class="card-img-top" alt="Naturgy">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-naturgy"> </h5> <a role="button"
                                id="btn-naturgy" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardbbva">
                <div class="card"> <img src="bbva.c07e569f.jpg" class="card-img-top" alt="BBVA">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-bbva"></h5> <a role="button" id="btn-bbva"
                                class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardinditex">
                <div class="card"> <img src="inditex.a8c70474.jpg" class="card-img-top" alt="Inditex">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-inditex"> </h5> <a role="button"
                                id="btn-inditex" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardsantander">
                <div class="card"> <img src="santander.f1a72f96.jpg" class="card-img-top" alt="Santander">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-santander"> </h5> <a role="button"
                                id="btn-santander" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardrepsol">
                <div class="card"> <img src="repsol.8593b8e1.jpg" class="card-img-top" alt="Repsol">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-repsol"></h5> <a role="button" id="btn-repsol"
                                class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-container col-lg-3 col-md-4 col-sm-6 d-none p-3" id="cardferrovial">
                <div class="card"> <img src="ferrovial.16141e5b.jpg" class="card-img-top" alt="Ferrpvial">
                    <div class="card-body text-center">
                        <div class="mb-auto mt-auto">
                            <h5 class="card-title stock-price" id="price-ferrovial"> </h5> <a role="button"
                                id="btn-ferrovial" class="btn btn-chart"> <i class="fa-chart-line fa-solid"></i> Abrir
                                gráfico</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="fade modal" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item"> <a class="active nav-link text-primary" aria-current="page" id="logInBtn"
                                data-bs-toggle="tab" href="#logInTab" role="tab" aria-controls="logInTab"
                                aria-selected="true">Log In <i class="fa-right-to-bracket fa-solid"></i></a> </li>
                        <li class="nav-item"> <a class="nav-link text-success" id="signUpBtn" data-bs-toggle="tab"
                                href="#signUpTab" role="tab" aria-controls="signUpTab" aria-selected="false">Sign Up <i
                                    class="fa-solid fa-user-plus"></i></a> </li>
                    </ul> <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body tab-content">
                    <div id="logInTab" class="active fade show tab-pane" role="tabpanel" aria-labelledby="logInTab">
                        <form id="loginForm">
                            <div class="mb-3"> <label for="emailLogIn" class="form-label">Email address</label> <input
                                    type="email" class="form-control" name="email" id="emailLogIn"
                                    aria-describedby="emailHelp">
                                <div id="emailHelp" class="form-text">We'll never share your email with anyone else.
                                </div>
                            </div>
                            <div class="mb-3"> <label for="exampleInputPassword1" class="form-label">Password</label>
                                <input type="password" name="password" class="form-control" id="exampleInputPassword1">
                            </div>
                            <div class="mb-3"> <button type="submit" class="btn btn-primary">Log In</button> </div>
                        </form>
                    </div>
                    <div id="signUpTab" class="fade tab-pane" role="tabpanel" aria-labelledby="signUpTab">
                        <form id="signUpForm">
                            <div class="mb-3"> <label for="name" class="form-label">Name</label> <input type="text"
                                    class="form-control" name="name" id="name"> <label for="emailSignUp"
                                    class="form-label">Email address</label> <input type="email" class="form-control"
                                    name="email" id="emailSignUp" aria-describedby="emailHelp">
                                <div id="emailHelp" class="form-text">We'll never share your email with anyone else.
                                </div>
                            </div>
                            <div class="mb-3"> <label for="password" class="form-label">Password</label> <input
                                    type="password" name="password" class="form-control" id="password"> </div>
                            <div class="mb-3"> <button type="submit" class="btn btn-success">Sign Up!</button> </div>
                        </form>
                    </div>
                </div>
                <div class="alert alert-danger d-none modal-footer" id="loginAlert" role="alert"> </div>
            </div>
        </div>
    </div>
    <div class="fade modal" id="settingsModal" aria-labelledby="settingsModalLabel" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"> <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button> </div>
                <div class="modal-body">
                    <div class="row text-center">
                        <div class="col-6 text-danger">
                            <h1><i class="fa-eye-slash fa-solid"></i></h1>
                        </div>
                        <div class="col-6 text-success">
                            <h1><i class="fa-eye fa-solid"></i></h1>
                        </div>
                    </div>
                    <div class="row" id="targetImagenes">
                        <div class="col-6 selectBox" id="unselectedStocks"> <img class="configLogo w-100"
                                src="bbva.c07e569f.jpg" alt id="bbva"> <img class="configLogo w-100"
                                src="iberdrola.7b71389c.jpg" alt id="iberdrola"> <img class="configLogo w-100"
                                src="inditex.a8c70474.jpg" alt id="inditex"> <img class="configLogo w-100"
                                src="santander.f1a72f96.jpg" alt id="santander"> <img class="configLogo w-100"
                                src="naturgy.2b60e181.jpg" alt id="naturgy"> <img class="configLogo w-100"
                                src="cellnex.1d49f6a5.jpg" alt id="cellnex"> <img class="configLogo w-100"
                                src="caixabank.56d93953.jpg" alt id="caixabank"> <img class="configLogo w-100"
                                src="telefonica.86c45e26.jpg" alt id="telefonica"> <img class="configLogo w-100"
                                src="repsol.8593b8e1.jpg" alt id="repsol"> <img class="configLogo w-100"
                                src="ferrovial.16141e5b.jpg" alt id="ferrovial"> </div>
                        <div class="col-6 selectBox" id="selectedStocks"> </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center"> <button class="btn btn-primary" id="saveSettingsBtn"
                                data-bs-dismiss="modal">Guardar</button> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="fade modal" id="modalChart" aria-labelledby="modalChartLabel" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        aria-label="Close"></button> </div>
                <div class="modal-body" id="containerGrafico"> </div>
            </div>
        </div>
    </div>
    <div id="timer"></div>
    <div id="settingsButton" title="Ajustes de visibilidad" role="button" data-bs-toggle="modal"
        data-bs-target="#settingsModal"> <i class="fa-solid fa-wrench"></i> </div>
</body>
<script>
    function getCookie(name) {
      var cookieArr = document.cookie.split(";");
      for(var i = 0; i < cookieArr.length; i++) {
          var cookiePair = cookieArr[i].split("=");
          if(name == cookiePair[0].trim()) {
              return decodeURIComponent(cookiePair[1]);
          }
      }
      return null;
  }
  function eraseCookie(name) {
      document.cookie = name + '=; Max-Age=0'
  }
  var updateInterval;
  var updateTime;
  var logged = false
  var loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
      keyboard: false
    })
  var settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'),{
      keyboard: false
  })
  var modalChart = new bootstrap.Modal(document.getElementById('modalChart'),{
      keyboard: false
  })
  
  var chart;
  var empresas;
  
  async function loggin(){
      logged = true;
      document.getElementById('username').innerText = getCookie('user');
      await refreshData() 
      await UpdateCardsEmpresas()
      document.getElementById('logOut').classList.remove('d-none')
      document.getElementById('logIn').classList.add('d-none')
  }
  async function logout(){
      logged = false
      document.getElementById('username').innerText = ''
      await UpdateCardsEmpresas()
      document.getElementById('logIn').classList.remove('d-none')
      document.getElementById('logOut').classList.add('d-none')
      loginModal.show()
  }
  
  if (getCookie('access_token') != null){
      loggin()
  }else{
      logout()
  }
  
  if(localStorage.getItem("stocksSelected") !== null){
      JSON.parse(localStorage.stocksSelected).forEach(item => {
          document.getElementById(`card${item}`).classList.remove('d-none')
          document.getElementById('selectedStocks').appendChild(document.getElementById(`${item}`))
      })
  }
  
  
  $( function() {
      $( ".configLogo" ).draggable({
          scroll: false,
          axis: "x",
          containment: '#targetImagenes',
          revert: "invalid",
      });
      $(".configLogo").sortable({
          axis: "x"
      })
      $("#selectedStocks").droppable({
          accept: ".configLogo",
          drop: function(e,ui){
              $(e.target).append($(ui.draggable).detach().css({'top':'','left':''}))
          }
      })
      $("#unselectedStocks").droppable({
          accept: ".configLogo",
          drop: function(e,ui){
              $(e.target).append($(ui.draggable).detach().css({'top':'','left':''}))
          }
      })
  });
  
  if (/Android|iPhone/i.test(navigator.userAgent)) {
      [...document.getElementsByClassName('configLogo')].forEach(elem => {
          elem.addEventListener('click',() => {
              const id= event.currentTarget.parentNode.id
              if(id == 'selectedStocks'){
                  document.getElementById('unselectedStocks').appendChild(event.currentTarget)
              }else{
                  document.getElementById('selectedStocks').appendChild(event.currentTarget)
              }
          })
      })
  }
  resetContador()
  async function register(){
      var data = new FormData(document.getElementById('signUpForm'))
      const res = await fetch('${api}/api/register',{
          method: 'POST',
          body: data,
          Accept: 'application/json'
      })
      return res.json()
  }
  
  async function logIn(){
      var data = new FormData(document.getElementById('loginForm'))
      const res = await fetch('${api}/api/login',{
          method: 'POST',
          body: data,
          Accept: 'application/json'
      })
      return res.json()
  }
  async function fetchEmpresas(){
      const res = await fetch(`${api}/api/empresas`,{
          headers: {
              Authorization: 'Bearer '+getCookie('access_token'),
              Accept: 'application/json'
          }
      })
      return res.json()
  }
  async function fetchStockData(id_empresa){
      const res = await fetch(`${api}/api/acciones/empresa/${id_empresa}`,{
          headers: {
              Authorization: 'Bearer '+getCookie('access_token'),
              Accept: 'application/json'
          }
      })
      return res.json()
  }
  
  async function crearChart(empresa){
      const idEmpresa = empresas.find(emp => (emp.nombre).toLowerCase() == empresa.toLowerCase()).id
      var seriesAcciones = [];
      JSON.parse(localStorage.stocksSelected).forEach(async (item) =>{
        const id = empresas.find(emp => (emp.nombre).toLowerCase() == item.toLowerCase()).id
        var visible = id == idEmpresa
        seriesAcciones.push({
          name: item.toUpperCase(),
          data: datos[id],
          setVisible: visible,
          tooltip: {
            valueDecimals: 2
          }
        });
      })
      const datos = await fetchStockData(idEmpresa)
      var options = {
        rangeSelector: {
          selected: 1
        },
        title: {
          text: `Acciones`
        },
        series: seriesAcciones
      }
      //// Create the chart
      chart = Highcharts.stockChart('containerGrafico', options);
  }
  
function UpdateCardEmpresa(empresa){
      console.log(JSON.stringify(empresa))
      const latest_value = empresa.valores[(empresa.valores).length-1][1]
      const prev = empresa.valores[(empresa.valores).length-2][1]
      document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).innerText = latest_value+'€';
      if ((parseFloat(latest_value)-parseFloat(prev))>0){
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.add('text-success')
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.remove('text-danger')
      }else if ((parseFloat(latest_value)-parseFloat(prev))<0){
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.remove('text-success')
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.add('text-danger')
      }
      setTimeout(() => {
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.remove('text-success')
          document.getElementById(`price-${(empresa.nombre).toLowerCase()}`).classList.remove('text-danger')
      },5000)
  
  }
  function UpdateCardsEmpresas(){
        if (logged){ 
            empresas.forEach(empresa => {
                UpdateCardEmpresa(empresa)
            })
        }else{
            document.getElementById(`price-${item}`).innerHTML = ''
            document.getElementById(`price-${item}`).classList.remove('text-success')
        }          
  }
  
  
  [...document.getElementsByClassName('btn-chart')].forEach(elem => {
      elem.addEventListener('click',async () => {
          if (!logged){
              loginModal.show()
              return
          }
          if(chart != undefined){
              chart.destroy()
          }
          await crearChart(elem.id.replace('btn-',''))
          modalChart.show()
      })
  })
  
  function resetContador(){
      clearInterval(updateInterval)
      updateTime = 60
      updateInterval = setInterval(() =>  {
          updateTime--; 
          document.getElementById('timer').innerText = updateTime
      },1000)
  }

  document.getElementById('signUpForm').addEventListener('submit', async function(event){
      event.preventDefault()  
      const res = await register()
      if (res.access_token != undefined){
       
          document.cookie = `user = ${res.user.name}; max-age=7200`
          document.cookie = `access_token = ${res.access_token}; max-age=7200`
          loginModal.hide()
          $(".modal-backdrop").remove()
      }else{
          document.getElementById('loginAlert').classList.remove('d-none')
          document.getElementById('loginAlert').innerText = res.message
      }
  })
  
  document.getElementById('logOut').addEventListener('click', () => {
      eraseCookie('access_token')
  })
      
  
  
  document.getElementById('loginForm').addEventListener('submit',async function(event){
      event.preventDefault()
      const res = await logIn()
      if (res.access_token != undefined){
          document.cookie = `user = ${res.user.name}; max-age=7200`
          document.cookie = `access_token = ${res.access_token}; max-age=7200`
          loginModal.hide()
          $(".modal-backdrop").remove()
      }else{
          document.getElementById('loginAlert').classList.remove('d-none')
          document.getElementById('loginAlert').innerText = res.message
      }
  })
  
  document.getElementById('saveSettingsBtn').addEventListener('click', () => {
      var elegidos = [...document.getElementById('selectedStocks').children].map(item => item.id)
      elegidos.forEach(item => document.getElementById(`card${item}`).classList.remove('d-none'))
      var noElegidos = [...document.getElementById('unselectedStocks').children].map(item => item.id)
      noElegidos.forEach(item => document.getElementById(`card${item}`).classList.add('d-none'))
      localStorage.setItem("stocksSelected",JSON.stringify(elegidos))
      UpdateCardsEmpresas()
  })
  
  
  //Listener para cambiar el estado de los elementos cuando se está logueado o no
  var cookieListener = setInterval(async () => {
      if (getCookie('access_token') != null && !logged){
          await loggin() 
      }else if (getCookie('access_token') == null && logged){
          await logout()
      }
  },100)
  

  async function refreshData(){
    empresas = await fetchEmpresas()
    empresas.forEach(async(emp) => emp['valores'] = await fetchStockData(emp.id))
  }

  //Cambiamos los valores mostrados en las tarjetas
  setInterval(async() => {
      await refreshData()
      await UpdateCardsEmpresas()
      resetContador()
  },60*1000)
  
  </script>

</html>